@page "/orders"
@using ShawarmaShop.Models
@using ShawarmaShop.ViewModels
@inject OrderViewModel OrderVM
@inject CustomerViewModel CustomerVM
@inject SellerViewModel SellerVM
@inject ShawarmaViewModel ShawarmaVM

<h3>Управление заказами</h3>

<div class="row">
    <div class="col-md-6">
        <EditForm Model="@newOrder" OnValidSubmit="@AddOrder">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="form-group">
                <label>Покупатель</label>
                <InputSelect @bind-Value="newOrder.CustomerId" class="form-control">
                    @foreach (var customer in CustomerVM.Customers)
                    {
                        <option value="@customer.Id">@customer.Name</option>
                    }
                </InputSelect>
            </div>
            <div class="form-group">
                <label>Продавец</label>
                <InputSelect @bind-Value="newOrder.SellerId" class="form-control">
                    @foreach (var seller in SellerVM.Sellers)
                    {
                        <option value="@seller.Id">@seller.Name</option>
                    }
                </InputSelect>
            </div>
            <div class="form-group">
                <label>Шаурма</label>
                <div>
                    @foreach (var shawarma in ShawarmaVM.Shawarmas)
                    {
                        <div class="form-check">
                            <InputCheckbox @bind-Value="@selectedShawarmas[shawarma.Id]"
                                           class="form-check-input"
                                           id="@shawarma.Id" />
                            <label class="form-check-label" for="@shawarma.Id">
                                @shawarma.Name (@shawarma.Price руб.)
                            </label>
                        </div>
                    }
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Создать заказ</button>
        </EditForm>
    </div>
    <div class="col-md-6">
        <table class="table">
            <thead>
                <tr>
                    <th>Покупатель</th>
                    <th>Продавец</th>
                    <th>Сумма</th>
                    <th>Дата</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var order in OrderVM.Orders)
                {
                    <tr>
                        <td>@(CustomerVM.Customers.FirstOrDefault(c => c.Id == order.CustomerId)?.Name)</td>
                        <td>@(SellerVM.Sellers.FirstOrDefault(s => s.Id == order.SellerId)?.Name)</td>
                        <td>@order.TotalPrice</td>
                        <td>@order.OrderDate</td>
                        <td>
                            <button @onclick="() => DeleteOrder(order.Id)" class="btn btn-danger btn-sm">Удалить</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@code {
    private Order newOrder = new Order();
    private Dictionary<Guid, bool> selectedShawarmas = new Dictionary<Guid, bool>();

    protected override void OnInitialized()
    {
        foreach (var shawarma in ShawarmaVM.Shawarmas)
        {
            selectedShawarmas[shawarma.Id] = false;
        }
    }

    private void AddOrder()
    {
        newOrder.ShawarmaIds = selectedShawarmas
            .Where(s => s.Value)
            .Select(s => s.Key)
            .ToList();

        newOrder.TotalPrice = OrderVM.CalculateOrderTotalPrice(newOrder, ShawarmaVM.Shawarmas.ToList());
        OrderVM.AddOrder(newOrder);

        newOrder = new Order();
        foreach (var key in selectedShawarmas.Keys.ToList())
        {
            selectedShawarmas[key] = false;
        }
    }

    private void DeleteOrder(Guid orderId)
    {
        OrderVM.DeleteOrder(orderId);
    }
}